<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contract Overview</title>
    <link rel="stylesheet" href="../css/style.css">
    <style>
        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-left: auto;
            padding-right: 1rem;
        }
        
        .user-badge {
            background: #007bff;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
            text-transform: uppercase;
        }
        
        .user-badge.admin { background: #dc3545; }
        .user-badge.manager { background: #28a745; }
        .user-badge.user { background: #6c757d; }
        
        .logout-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .logout-btn:hover {
            background: #c82333;
        }
        
        .access-denied {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 1rem;
            border-radius: 4px;
            margin: 1rem 0;
            text-align: center;
        }
    </style>
</head>

<body>
    <div class="navbar">
        <!-- Links on the left -->
        <ul class="nav-links" id="nav-links">
            <li><a href="dashboard.html">Dashboard</a></li>
            <!-- Manage Contract tab will be shown/hidden based on role -->
            <li id="manage-contract-nav" style="display: none;">
                <a href="manage_contract.html">Manage Contract</a>
            </li>
            <!-- Users tab only for admins -->
            <li id="users-nav" style="display: none;">
                <a href="users.php">Users</a>
            </li>
        </ul>

        <!-- User info and logout -->
        <div class="user-info" id="user-info">
            <span id="username-display">Loading...</span>
            <span id="role-badge" class="user-badge">user</span>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>

        <!-- Logo on the right -->
        <div class="nwr_logo">
            <img src="../images/nwr_logo.png" alt="NWR Logo" style="height:60px;">
        </div>
    </div>

    <div class="container">
        <h1>Contract Dashboard</h1>

        <!-- Role-based access message -->
        <div id="role-info" style="margin-bottom: 1rem; padding: 1rem; background: #e7f3ff; border-left: 4px solid #007bff; border-radius: 4px;">
            <p id="role-message">Loading user information...</p>
        </div>

        <!-- Filters -->
        <div class="filters">
            <input type="text" class="search-bar" placeholder="Search by Party or Contract Type...">
        </div>

        <p class="note">Contracts with a notification date on or before today are highlighted in red.</p>

        <ul>
            <button id="download-csv">Download All Contracts as CSV</button>
        </ul>

        <table id="contracts-table">
            <thead>
                <tr>
                    <th>Contract ID</th>
                    <th>Parties</th>
                    <th>Type of Contract</th>
                    <th>Duration</th>
                    <th>Description</th>
                    <th>Expiry Date</th>
                    <th>Review By</th>
                    <th>Contract Value</th>
                </tr>
            </thead>
            <tbody>
                <!-- Data will be inserted here -->
            </tbody>
        </table>
    </div>

    <script>
        // Check authentication and load user info
        let currentUser = null;
        
        async function checkAuth() {
            try {
                const response = await fetch('/nwrcontractregistry/backend/auth_handler.php?action=check');
                const result = await response.json();
                
                if (!result.loggedIn) {
                    window.location.href = '../index.php';
                    return false;
                }
                
                currentUser = result.user;
                updateUI();
                return true;
            } catch (error) {
                console.error('Auth check failed:', error);
                window.location.href = '../index.php';
                return false;
            }
        }
        
        function updateUI() {
            if (!currentUser) return;
            
            // Update user display
            document.getElementById('username-display').textContent = currentUser.username;
            const roleBadge = document.getElementById('role-badge');
            roleBadge.textContent = currentUser.role;
            roleBadge.className = `user-badge ${currentUser.role}`;
            
            // Update role info message
            const roleMessages = {
                'user': 'You have view-only access to contracts. Contact an administrator to request additional permissions.',
                'manager': 'You can view, create, and modify contracts.',
                'admin': 'You have full access to contracts and user management.'
            };
            
            document.getElementById('role-message').textContent = roleMessages[currentUser.role] || 'Access level: ' + currentUser.role;
            
            // Show/hide navigation items based on role
            if (currentUser.role === 'manager' || currentUser.role === 'admin') {
                const manageNav = document.getElementById('manage-contract-nav');
    if (manageNav) manageNav.style.display = 'block';
            }
            
            if (currentUser.role === 'admin') {
                const usersNav = document.getElementById('users-nav');
                if (usersNav) usersNav.style.display = 'block';
            }
        }
        
        async function logout() {
            try {
                const response = await fetch('/nwrcontractregistry/backend/auth_handler.php?action=logout', {
                    method: 'POST'
                });
                
                // Redirect to login regardless of response
                window.location.href = '../index.php';
            } catch (error) {
                console.error('Logout error:', error);
                // Still redirect to login
                window.location.href = '../index.php';
            }
        }

        async function loadContracts() {
            console.log("Loading contracts...");

            const backendUrl = "/nwrcontractregistry/backend/index.php?action=list";

            try {
                const response = await fetch(backendUrl);
                if (!response.ok) {
                    if (response.status === 401) {
                        window.location.href = '../index.php';
                        return;
                    }
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                let contracts = await response.json();
                const tbody = document.querySelector("#contracts-table tbody");
                tbody.innerHTML = "";

                if (Array.isArray(contracts) && contracts.length > 0) {
                    // Sort by expiry date (earliest first, null/invalid at the end)
                    contracts.sort((a, b) => {
                        const dateA = a.expiryDate ? new Date(a.expiryDate) : null;
                        const dateB = b.expiryDate ? new Date(b.expiryDate) : null;

                        if (!dateA && !dateB) return 0;
                        if (!dateA) return 1; // push invalid/empty dates to bottom
                        if (!dateB) return -1;

                        return dateA - dateB; // earliest first
                    });

                    contracts.forEach((contract) => {
                        const tr = document.createElement("tr");

                        let formattedValue = "N/A";
                        if (contract.contractValue && !isNaN(contract.contractValue)) {
                            formattedValue =
                                "N$ " +
                                new Intl.NumberFormat("en-US", {
                                    minimumFractionDigits: 2,
                                    maximumFractionDigits: 2,
                                }).format(parseFloat(contract.contractValue));
                        }

                        tr.innerHTML = `
                            <td>${contract.contractid || "N/A"}</td>
                            <td>${contract.parties || "N/A"}</td>
                            <td>${contract.typeOfContract || "N/A"}</td>
                            <td>${contract.duration || "N/A"}</td>
                            <td>${contract.description || "N/A"}</td>
                            <td>${contract.expiryDate || "N/A"}</td>
                            <td>${contract.reviewByDate || "N/A"}</td>
                            <td>${formattedValue}</td>
                        `;

                        // Highlight expired contracts
                        if (contract.expiryDate) {
                            const today = new Date();
                            today.setHours(0, 0, 0, 0);
                            const expiryDate = new Date(contract.expiryDate);
                            if (expiryDate <= today) {
                                tr.style.backgroundColor = "#ffcdd2";
                                tr.style.color = "#c62828";
                            }
                        }

                        tbody.appendChild(tr);
                    });
                } else {
                    tbody.innerHTML =
                        '<tr><td colspan="8" style="text-align: center;">No contracts found</td></tr>';
                }
            } catch (err) {
                console.error("Error loading contracts:", err);
                const tbody = document.querySelector("#contracts-table tbody");
                if (tbody) {
                    tbody.innerHTML = `<tr><td colspan="8" style="text-align: center; color: red;">Error: ${err.message}</td></tr>`;
                }
            }
        }

        // Initialize page
        document.addEventListener("DOMContentLoaded", async () => {
            const isAuthenticated = await checkAuth();
            if (isAuthenticated) {
                loadContracts();
                
                // CSV Export
                document
                    .getElementById("download-csv")
                    ?.addEventListener("click", function () {
                        const rows = [
                            [
                                "Contract ID",
                                "Parties",
                                "Type of Contract",
                                "Duration",
                                "Description",
                                "Expiry Date",
                                "Review By",
                                "Contract Value",
                            ],
                        ];

                        document.querySelectorAll("#contracts-table tbody tr").forEach((tr) => {
                            const cols = tr.querySelectorAll("td");
                            const row = Array.from(cols).map((td) => td.innerText.trim());
                            rows.push(row);
                        });

                        const csvContent =
                            "data:text/csv;charset=utf-8," +
                            rows
                                .map((r) => r.map((v) => `"${v.replace(/"/g, '""')}"`).join(","))
                                .join("\n");

                        const downloadLink = document.createElement("a");
                        downloadLink.href = encodeURI(csvContent);
                        downloadLink.download = "contracts.csv";
                        document.body.appendChild(downloadLink);
                        downloadLink.click();
                        document.body.removeChild(downloadLink);
                    });

                // Search filter
                const searchInput = document.querySelector(".search-bar");
                const tableBody = document.querySelector("#contracts-table tbody");

                function filterContracts() {
                    const searchText = searchInput?.value.toLowerCase() || "";

                    Array.from(tableBody.querySelectorAll("tr")).forEach((row) => {
                        const party = row.children[1].textContent.toLowerCase();
                        const type = row.children[2].textContent.toLowerCase();

                        let matchesSearch =
                            !searchText || party.includes(searchText) || type.includes(searchText);

                        row.style.display = matchesSearch ? "" : "none";
                    });
                }

                searchInput?.addEventListener("input", filterContracts);
            }
        });
    </script>
</body>
</html>