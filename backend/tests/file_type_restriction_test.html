<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Type Restriction Test - NWR Contract Registry</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; background: #f5f7fa; }
        .header { text-align: center; background: linear-gradient(135deg, #dc3545, #e83e8c); color: white; padding: 30px; border-radius: 15px; margin-bottom: 25px; }
        .test-section { background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin: 20px 0; overflow: hidden; }
        .section-header { padding: 20px; font-size: 1.2em; font-weight: bold; color: white; }
        .section-body { padding: 20px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; padding: 15px; border-radius: 8px; margin: 10px 0; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; padding: 15px; border-radius: 8px; margin: 10px 0; }
        .warning { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 15px; border-radius: 8px; margin: 10px 0; }
        .info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; padding: 15px; border-radius: 8px; margin: 10px 0; }
        .test-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 20px 0; }
        .test-card { background: #f8f9fa; padding: 20px; border-radius: 10px; border: 1px solid #dee2e6; }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin: 5px; text-decoration: none; display: inline-block; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-warning { background: #ffc107; color: #333; }
        .change-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
        .before, .after { padding: 15px; border-radius: 8px; }
        .before { background: #f8d7da; border-left: 4px solid #dc3545; }
        .after { background: #d4edda; border-left: 4px solid #28a745; }
        .code-block { background: #f8f9fa; padding: 10px; border-radius: 5px; font-family: 'Courier New', monospace; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîí File Type Restriction Test</h1>
        <h2>Updated to PDF, DOC, DOCX Only</h2>
        <p>Testing the new file type restrictions</p>
        <p><strong>Test Date:</strong> <?php echo date('Y-m-d H:i:s'); ?></p>
    </div>

    <div class="test-section">
        <div class="section-header" style="background: linear-gradient(135deg, #28a745, #20c997);">
            ‚úÖ Changes Applied
        </div>
        <div class="section-body">
            <div class="success">
                <h3>File Type Restriction Updated Successfully</h3>
                <p>The upload system has been updated to only allow PDF, DOC, and DOCX files.</p>
            </div>
            
            <div class="change-grid">
                <div class="before">
                    <h4>‚ùå Before (6 file types):</h4>
                    <div class="code-block">
$allowedExtensions = ['pdf', 'doc', 'docx', 'txt', 'xlsx', 'xls'];
                    </div>
                    <p><strong>Allowed:</strong> PDF, DOC, DOCX, TXT, XLSX, XLS</p>
                </div>
                <div class="after">
                    <h4>‚úÖ After (3 file types):</h4>
                    <div class="code-block">
$allowedExtensions = ['pdf', 'doc', 'docx'];
                    </div>
                    <p><strong>Allowed:</strong> PDF, DOC, DOCX only</p>
                </div>
            </div>
        </div>
    </div>

    <div class="test-section">
        <div class="section-header" style="background: linear-gradient(135deg, #17a2b8, #20c997);">
            üß™ Validation Tests
        </div>
        <div class="section-body">
            <div class="test-grid">
                <div class="test-card">
                    <h3>‚úÖ Allowed File Types</h3>
                    <p><strong>Should be accepted:</strong></p>
                    <ul>
                        <li>üìÑ PDF files (.pdf)</li>
                        <li>üìù Word 97-2003 (.doc)</li>
                        <li>üìù Word 2007+ (.docx)</li>
                    </ul>
                    <button class="btn btn-success" onclick="testAllowedTypes()">Test Allowed Types</button>
                </div>
                
                <div class="test-card">
                    <h3>‚ùå Blocked File Types</h3>
                    <p><strong>Should be rejected:</strong></p>
                    <ul>
                        <li>üìÑ Text files (.txt)</li>
                        <li>üìä Excel 2007+ (.xlsx)</li>
                        <li>üìä Excel 97-2003 (.xls)</li>
                        <li>‚ö†Ô∏è Executable files (.exe)</li>
                        <li>‚ö†Ô∏è Script files (.php, .js)</li>
                    </ul>
                    <button class="btn btn-danger" onclick="testBlockedTypes()">Test Blocked Types</button>
                </div>
                
                <div class="test-card">
                    <h3>üîç Frontend Validation</h3>
                    <p><strong>File input restrictions:</strong></p>
                    <div class="code-block">accept=".pdf,.doc,.docx"</div>
                    <input type="file" id="testFileInput" accept=".pdf,.doc,.docx" style="margin: 10px 0;">
                    <p><small>Try selecting different file types above</small></p>
                </div>
                
                <div class="test-card">
                    <h3>üõ°Ô∏è Server Security</h3>
                    <p><strong>.htaccess updated:</strong></p>
                    <div class="code-block">&lt;FilesMatch "\.(pdf|doc|docx)$"&gt;
    Allow from all
&lt;/FilesMatch&gt;</div>
                    <button class="btn btn-warning" onclick="testServerSecurity()">Test Server Security</button>
                </div>
            </div>
            
            <div id="testResults"></div>
        </div>
    </div>

    <div class="test-section">
        <div class="section-header" style="background: linear-gradient(135deg, #6f42c1, #e83e8c);">
            üìã Updated Components
        </div>
        <div class="section-body">
            <div class="info">
                <h3>üîß Components Updated:</h3>
                <ul>
                    <li>‚úÖ <strong>Backend validation:</strong> /backend/index.php - Updated $allowedExtensions array</li>
                    <li>‚úÖ <strong>Frontend forms:</strong> /frontend/pages/manage_contract.html - Updated accept attributes</li>
                    <li>‚úÖ <strong>JavaScript validation:</strong> /frontend/js/manage_contract.js - Updated allowedExtensions</li>
                    <li>‚úÖ <strong>Download handler:</strong> /backend/download_file.php - Updated regex pattern and content types</li>
                    <li>‚úÖ <strong>Server security:</strong> /backend/uploads/.htaccess - Updated FilesMatch rules</li>
                </ul>
            </div>
            
            <div class="warning">
                <h3>‚ö†Ô∏è Impact Assessment:</h3>
                <ul>
                    <li><strong>Existing files:</strong> TXT, XLSX, XLS files already uploaded will remain accessible</li>
                    <li><strong>New uploads:</strong> Only PDF, DOC, DOCX files can be uploaded</li>
                    <li><strong>User experience:</strong> File picker will only show allowed file types</li>
                    <li><strong>Error messages:</strong> Clear feedback when unsupported types are attempted</li>
                </ul>
            </div>
        </div>
    </div>

    <div class="test-section">
        <div class="section-header" style="background: linear-gradient(135deg, #fd7e14, #ffc107);">
            üîç Live Testing
        </div>
        <div class="section-body">
            <div class="info">
                <h3>Test Upload Restrictions:</h3>
                <p>Use the form below to test the new file type restrictions:</p>
            </div>
            
            <form id="testUploadForm" style="margin: 20px 0;">
                <div style="margin: 15px 0;">
                    <label for="testUpload"><strong>Select a file to test:</strong></label>
                    <input type="file" id="testUpload" accept=".pdf,.doc,.docx" style="margin: 10px 0; padding: 10px; width: 100%;">
                </div>
                <div style="margin: 15px 0;">
                    <input type="number" id="testContractId" placeholder="Contract ID (e.g., 99)" value="99" style="padding: 10px; margin-right: 10px;">
                    <button type="button" class="btn btn-primary" onclick="testFileUpload()">üß™ Test Upload</button>
                </div>
            </form>
            
            <div id="uploadTestResults"></div>
        </div>
    </div>

    <div style="text-align: center; background: linear-gradient(135deg, #28a745, #20c997); color: white; padding: 30px; border-radius: 15px; margin: 30px 0;">
        <h2>üéâ FILE TYPE RESTRICTION APPLIED!</h2>
        <p style="font-size: 1.2em; margin: 15px 0;">Upload system now restricted to PDF, DOC, and DOCX files only</p>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0;">
            <div>
                <div style="font-size: 1.5em; font-weight: bold;">üìÑ PDF</div>
                <div>Portable Document Format</div>
            </div>
            <div>
                <div style="font-size: 1.5em; font-weight: bold;">üìù DOC</div>
                <div>Microsoft Word 97-2003</div>
            </div>
            <div>
                <div style="font-size: 1.5em; font-weight: bold;">üìù DOCX</div>
                <div>Microsoft Word 2007+</div>
            </div>
            <div>
                <div style="font-size: 1.5em; font-weight: bold;">üö´ Others</div>
                <div>Blocked (TXT, XLS, XLSX, etc.)</div>
            </div>
        </div>
        <p><strong>Your file upload system is now more secure and focused!</strong></p>
    </div>

    <script>
        function testAllowedTypes() {
            addResult('üß™ Testing allowed file types...');
            
            const allowedTypes = ['pdf', 'doc', 'docx'];
            allowedTypes.forEach(type => {
                // Simulate validation
                const isAllowed = ['pdf', 'doc', 'docx'].includes(type);
                if (isAllowed) {
                    addResult(`‚úÖ ${type.toUpperCase()} files: ALLOWED`, 'success');
                } else {
                    addResult(`‚ùå ${type.toUpperCase()} files: BLOCKED`, 'error');
                }
            });
        }
        
        function testBlockedTypes() {
            addResult('üß™ Testing blocked file types...');
            
            const blockedTypes = ['txt', 'xlsx', 'xls', 'exe', 'php', 'js'];
            blockedTypes.forEach(type => {
                // Simulate validation
                const isAllowed = ['pdf', 'doc', 'docx'].includes(type);
                if (!isAllowed) {
                    addResult(`‚úÖ ${type.toUpperCase()} files: PROPERLY BLOCKED`, 'success');
                } else {
                    addResult(`‚ùå ${type.toUpperCase()} files: INCORRECTLY ALLOWED`, 'error');
                }
            });
        }
        
        function testServerSecurity() {
            addResult('üõ°Ô∏è Testing server security with blocked file types...');
            
            // Test access to TXT file (should be blocked now)
            fetch('../uploads/test.txt')
                .then(response => {
                    if (response.status === 403) {
                        addResult('‚úÖ TXT files blocked by server (403 Forbidden)', 'success');
                    } else {
                        addResult('‚ö†Ô∏è TXT files may still be accessible', 'warning');
                    }
                })
                .catch(error => {
                    addResult('‚úÖ TXT files properly blocked by server', 'success');
                });
                
            // Test access to PDF file (should still work)
            fetch('../uploads/29.20251006-085545.pdf', {method: 'HEAD'})
                .then(response => {
                    if (response.ok) {
                        addResult('‚úÖ PDF files still accessible', 'success');
                    } else {
                        addResult('‚ùå PDF access may be blocked', 'error');
                    }
                })
                .catch(error => {
                    addResult('‚ö†Ô∏è PDF access test inconclusive', 'warning');
                });
        }
        
        function testFileUpload() {
            const fileInput = document.getElementById('testUpload');
            const contractId = document.getElementById('testContractId').value;
            
            if (!fileInput.files.length) {
                addUploadResult('‚ùå Please select a file to test', 'error');
                return;
            }
            
            const file = fileInput.files[0];
            const extension = file.name.split('.').pop().toLowerCase();
            
            addUploadResult(`üîÑ Testing upload: ${file.name} (${extension.toUpperCase()})`, 'info');
            
            const formData = new FormData();
            formData.append('action', 'upload_contract_file');
            formData.append('contract_id', contractId);
            formData.append('contract_file', file);
            
            fetch('../index.php', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addUploadResult(`‚úÖ Upload successful: ${data.message || 'File uploaded'}`, 'success');
                } else {
                    const isExpectedError = !['pdf', 'doc', 'docx'].includes(extension);
                    if (isExpectedError) {
                        addUploadResult(`‚úÖ Upload correctly rejected: ${data.error}`, 'success');
                    } else {
                        addUploadResult(`‚ùå Upload failed unexpectedly: ${data.error}`, 'error');
                    }
                }
            })
            .catch(error => {
                addUploadResult(`‚ùå Upload test error: ${error.message}`, 'error');
            });
        }
        
        function addResult(message, type = 'info') {
            const resultsDiv = document.getElementById('testResults');
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = message;
            resultsDiv.appendChild(div);
        }
        
        function addUploadResult(message, type = 'info') {
            const resultsDiv = document.getElementById('uploadTestResults');
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = message;
            resultsDiv.appendChild(div);
        }
    </script>
</body>
</html>