<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Download Test - NWR Contract Registry</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; background: #f5f7fa; }
        .header { text-align: center; background: linear-gradient(135deg, #17a2b8, #20c997); color: white; padding: 30px; border-radius: 15px; margin-bottom: 25px; }
        .download-section { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin: 20px 0; }
        .file-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 20px 0; }
        .file-card { background: #f8f9fa; padding: 20px; border-radius: 10px; border: 1px solid #dee2e6; transition: transform 0.2s; }
        .file-card:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.1); }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin: 5px; text-decoration: none; display: inline-block; transition: all 0.3s; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-info { background: #17a2b8; color: white; }
        .btn-warning { background: #ffc107; color: #333; }
        .btn:hover { transform: translateY(-2px); }
        .results { margin: 20px 0; padding: 15px; border-radius: 8px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        .file-icon { font-size: 2em; margin-bottom: 10px; }
        .download-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 20px 0; }
        .stat-card { background: #e9ecef; padding: 15px; border-radius: 8px; text-align: center; }
        .test-methods { display: flex; gap: 15px; flex-wrap: wrap; margin: 20px 0; }
    </style>
</head>
<body>
    <div class="header">
        <h1>📥 File Download Test</h1>
        <p>Testing secure file download functionality</p>
        <p><strong>Date:</strong> <?php echo date('Y-m-d H:i:s'); ?></p>
    </div>

    <div class="download-section">
        <h2>🔍 Authentication Status</h2>
        <div id="authStatus">Checking authentication...</div>
        
        <div class="test-methods">
            <button class="btn btn-info" onclick="checkAuthStatus()">🔄 Refresh Auth Status</button>
            <a href="../frontend/index.php" class="btn btn-warning" target="_blank">🔑 Login Page</a>
            <button class="btn btn-success" onclick="testLoginProcess()">🧪 Test Login Process</button>
        </div>
    </div>

    <div class="download-section">
        <h2>📁 Available Files for Download</h2>
        <div class="file-grid" id="fileGrid">
            Loading files...
        </div>
    </div>

    <div class="download-section">
        <h2>📊 Download Test Results</h2>
        <div class="download-stats">
            <div class="stat-card">
                <strong>Download Attempts</strong>
                <div id="downloadAttempts">0</div>
            </div>
            <div class="stat-card">
                <strong>Successful Downloads</strong>
                <div id="successfulDownloads">0</div>
            </div>
            <div class="stat-card">
                <strong>Failed Downloads</strong>
                <div id="failedDownloads">0</div>
            </div>
            <div class="stat-card">
                <strong>Security Blocks</strong>
                <div id="securityBlocks">0</div>
            </div>
        </div>
        <div id="downloadResults"></div>
    </div>

    <div class="download-section">
        <h2>🛡️ Security Tests</h2>
        <div class="test-methods">
            <button class="btn btn-warning" onclick="testUnauthorizedDownload()">⚠️ Test Unauthorized Access</button>
            <button class="btn btn-warning" onclick="testInvalidFilename()">🚫 Test Invalid Filename</button>
            <button class="btn btn-warning" onclick="testDirectAccess()">🔒 Test Direct Upload Access</button>
            <button class="btn btn-info" onclick="testDownloadHandler()">✅ Test Secure Handler</button>
        </div>
        <div id="securityResults"></div>
    </div>

    <script>
        let downloadStats = {
            attempts: 0,
            successful: 0,
            failed: 0,
            securityBlocks: 0
        };

        // File information from backend
        const availableFiles = [
            {
                name: '18.20251006-091516.pdf',
                type: 'PDF Document',
                icon: '📄',
                contractId: 18,
                size: 'Unknown'
            },
            {
                name: '19.20251006-090553.pdf', 
                type: 'PDF Document',
                icon: '📄',
                contractId: 19,
                size: 'Unknown'
            },
            {
                name: '29.20251006-085545.pdf',
                type: 'PDF Document', 
                icon: '📄',
                contractId: 29,
                size: 'Unknown'
            },
            {
                name: '31.20250929-140848.docx',
                type: 'Word Document',
                icon: '📝',
                contractId: 31,
                size: 'Unknown'
            },
            {
                name: '32.20251006-085459.pdf',
                type: 'PDF Document',
                icon: '📄', 
                contractId: 32,
                size: 'Unknown'
            }
        ];

        document.addEventListener('DOMContentLoaded', function() {
            checkAuthStatus();
            displayFiles();
        });

        function checkAuthStatus() {
            addResult('authStatus', '🔄 Checking authentication status...', 'info');
            
            fetch('../auth_handler.php?action=check')
                .then(response => response.json())
                .then(data => {
                    if (data.loggedIn) {
                        addResult('authStatus', `✅ Authenticated as: ${data.user.username} (${data.user.role})`, 'success');
                    } else {
                        addResult('authStatus', '❌ Not authenticated - Login required for downloads', 'error');
                    }
                })
                .catch(error => {
                    addResult('authStatus', '❌ Authentication check failed - Server may be down', 'error');
                });
        }

        function displayFiles() {
            const fileGrid = document.getElementById('fileGrid');
            
            const filesHTML = availableFiles.map(file => `
                <div class="file-card">
                    <div class="file-icon">${file.icon}</div>
                    <h4>${file.name}</h4>
                    <p><strong>Type:</strong> ${file.type}</p>
                    <p><strong>Contract ID:</strong> ${file.contractId}</p>
                    <p><strong>Size:</strong> ${file.size}</p>
                    <div style="margin-top: 15px;">
                        <button class="btn btn-primary" onclick="downloadFile('${file.name}')">
                            📥 Download
                        </button>
                        <button class="btn btn-info" onclick="testFileAccess('${file.name}')">
                            🔍 Test Access
                        </button>
                    </div>
                </div>
            `).join('');
            
            fileGrid.innerHTML = filesHTML;
        }

        function downloadFile(filename) {
            downloadStats.attempts++;
            updateStats();
            
            addResult('downloadResults', `🔄 Attempting to download: ${filename}`, 'info');
            
            // Method 1: Try secure download handler
            const downloadUrl = `../download_file.php?file=${encodeURIComponent(filename)}`;
            
            fetch(downloadUrl, {
                method: 'GET',
                credentials: 'include'
            })
            .then(response => {
                if (response.ok) {
                    // If successful, trigger actual download
                    const link = document.createElement('a');
                    link.href = downloadUrl;
                    link.download = filename;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    downloadStats.successful++;
                    addResult('downloadResults', `✅ Download successful: ${filename}`, 'success');
                } else if (response.status === 401) {
                    downloadStats.securityBlocks++;
                    addResult('downloadResults', `🔒 Download blocked: Authentication required (${response.status})`, 'error');
                } else {
                    downloadStats.failed++;
                    addResult('downloadResults', `❌ Download failed: ${filename} (Status: ${response.status})`, 'error');
                }
                updateStats();
            })
            .catch(error => {
                downloadStats.failed++;
                addResult('downloadResults', `❌ Download error: ${error.message}`, 'error');
                updateStats();
            });
        }

        function testFileAccess(filename) {
            addResult('downloadResults', `🔍 Testing file access: ${filename}`, 'info');
            
            // Test HEAD request to check file accessibility
            fetch(`../download_file.php?file=${encodeURIComponent(filename)}`, {
                method: 'HEAD',
                credentials: 'include'
            })
            .then(response => {
                if (response.ok) {
                    const contentLength = response.headers.get('content-length');
                    const contentType = response.headers.get('content-type');
                    addResult('downloadResults', 
                        `✅ File accessible: ${filename}<br>
                         📏 Size: ${contentLength ? formatBytes(contentLength) : 'Unknown'}<br>
                         📄 Type: ${contentType || 'Unknown'}`, 'success');
                } else {
                    addResult('downloadResults', `❌ File not accessible: ${filename} (${response.status})`, 'error');
                }
            })
            .catch(error => {
                addResult('downloadResults', `❌ Access test failed: ${error.message}`, 'error');
            });
        }

        function testUnauthorizedDownload() {
            addResult('securityResults', '🔒 Testing unauthorized download access...', 'info');
            
            // Test without session/authentication
            fetch('../download_file.php?file=29.20251006-085545.pdf', {
                method: 'GET',
                credentials: 'omit'  // Don't send cookies/session
            })
            .then(response => {
                if (response.status === 401) {
                    downloadStats.securityBlocks++;
                    addResult('securityResults', '✅ Security working: Unauthorized access properly blocked (401)', 'success');
                } else {
                    addResult('securityResults', '❌ SECURITY ISSUE: Unauthorized access allowed!', 'error');
                }
                updateStats();
            })
            .catch(error => {
                downloadStats.securityBlocks++;
                addResult('securityResults', '✅ Security working: Access blocked by network policy', 'success');
                updateStats();
            });
        }

        function testInvalidFilename() {
            addResult('securityResults', '🚫 Testing invalid filename handling...', 'info');
            
            const invalidFilenames = [
                '../../../etc/passwd',
                'nonexistent.pdf',
                'malicious.php',
                '../../config/db.php'
            ];
            
            invalidFilenames.forEach(filename => {
                fetch(`../download_file.php?file=${encodeURIComponent(filename)}`, {
                    method: 'GET',
                    credentials: 'include'
                })
                .then(response => {
                    if (response.status >= 400) {
                        addResult('securityResults', `✅ Invalid filename blocked: ${filename} (${response.status})`, 'success');
                    } else {
                        addResult('securityResults', `❌ SECURITY ISSUE: Invalid filename allowed: ${filename}`, 'error');
                    }
                })
                .catch(error => {
                    addResult('securityResults', `✅ Invalid filename blocked: ${filename}`, 'success');
                });
            });
        }

        function testDirectAccess() {
            addResult('securityResults', '🔒 Testing direct upload directory access...', 'info');
            
            const directUrls = [
                '../uploads/29.20251006-085545.pdf',
                '../uploads/.htaccess',
                '../uploads/'
            ];
            
            directUrls.forEach(url => {
                fetch(url)
                    .then(response => {
                        if (response.status === 403 || response.status === 500) {
                            addResult('securityResults', `✅ Direct access blocked: ${url} (${response.status})`, 'success');
                        } else if (response.status === 404) {
                            addResult('securityResults', `ℹ️ File not found: ${url} (404)`, 'info');
                        } else {
                            addResult('securityResults', `❌ SECURITY ISSUE: Direct access allowed: ${url}`, 'error');
                        }
                    })
                    .catch(error => {
                        addResult('securityResults', `✅ Direct access blocked: ${url} (Network error)`, 'success');
                    });
            });
        }

        function testDownloadHandler() {
            addResult('securityResults', '✅ Testing secure download handler functionality...', 'info');
            
            // Test the download handler with a valid file
            fetch('../download_file.php?file=29.20251006-085545.pdf', {
                method: 'HEAD',
                credentials: 'include'
            })
            .then(response => {
                const headers = {
                    'content-type': response.headers.get('content-type'),
                    'content-disposition': response.headers.get('content-disposition'),
                    'x-content-type-options': response.headers.get('x-content-type-options'),
                    'x-frame-options': response.headers.get('x-frame-options')
                };
                
                if (response.ok) {
                    addResult('securityResults', 
                        `✅ Download handler working properly:<br>
                         📄 Content-Type: ${headers['content-type'] || 'Not set'}<br>
                         📥 Content-Disposition: ${headers['content-disposition'] || 'Not set'}<br>
                         🛡️ Security Headers: ${headers['x-content-type-options'] ? 'Present' : 'Missing'}`, 'success');
                } else {
                    addResult('securityResults', `❌ Download handler error: ${response.status}`, 'error');
                }
            })
            .catch(error => {
                addResult('securityResults', `❌ Handler test failed: ${error.message}`, 'error');
            });
        }

        function testLoginProcess() {
            addResult('authStatus', '🔄 Opening login page for authentication testing...', 'info');
            window.open('../frontend/index.php', '_blank');
            
            setTimeout(() => {
                addResult('authStatus', 'ℹ️ After logging in, refresh this page to test authenticated downloads', 'info');
            }, 1000);
        }

        function addResult(containerId, message, type) {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = `results ${type}`;
            div.innerHTML = message;
            container.appendChild(div);
            
            // Auto-scroll to new result
            div.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function updateStats() {
            document.getElementById('downloadAttempts').textContent = downloadStats.attempts;
            document.getElementById('successfulDownloads').textContent = downloadStats.successful;
            document.getElementById('failedDownloads').textContent = downloadStats.failed;
            document.getElementById('securityBlocks').textContent = downloadStats.securityBlocks;
        }

        function formatBytes(bytes) {
            if (bytes === '0' || bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
    </script>
</body>
</html>