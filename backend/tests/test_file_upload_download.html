<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Upload & Download Test - NWR Contract Registry</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; background: #f5f7fa; }
        .header { text-align: center; background: linear-gradient(135deg, #0758aa, #1e88e5); color: white; padding: 30px; border-radius: 15px; margin-bottom: 25px; }
        .test-section { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin: 20px 0; }
        .upload-area { border: 2px dashed #ccc; padding: 40px; text-align: center; border-radius: 10px; margin: 20px 0; background: #fafafa; transition: all 0.3s; }
        .upload-area:hover { border-color: #0758aa; background: #f0f8ff; }
        .upload-area.dragover { border-color: #28a745; background: #e8f5e8; }
        .file-input { margin: 15px 0; }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin: 5px; transition: all 0.3s; }
        .btn-primary { background: #0758aa; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: #333; }
        .btn-danger { background: #dc3545; color: white; }
        .btn:hover { transform: translateY(-2px); }
        .results { margin: 20px 0; padding: 15px; border-radius: 8px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        .file-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin: 20px 0; }
        .file-item { background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #dee2e6; }
        .progress-bar { width: 100%; height: 20px; background: #e9ecef; border-radius: 10px; overflow: hidden; margin: 10px 0; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #28a745, #20c997); transition: width 0.3s; }
        .test-files { display: flex; gap: 15px; flex-wrap: wrap; margin: 15px 0; }
        .test-file-btn { padding: 8px 16px; border: 1px solid #ccc; background: white; border-radius: 5px; cursor: pointer; }
        .size-display { font-family: monospace; background: #f8f9fa; padding: 5px 10px; border-radius: 4px; display: inline-block; margin: 5px 0; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìÅ File Upload & Download Test</h1>
        <p>Comprehensive testing of file upload/download functionality with 5MB limit</p>
    </div>

    <div class="test-section">
        <h2>üîß Current System Status</h2>
        <div id="systemStatus">Loading system status...</div>
    </div>

    <div class="test-section">
        <h2>üì§ File Upload Testing</h2>
        
        <div class="upload-area" id="uploadArea">
            <h3>üìÅ Drag & Drop Files Here</h3>
            <p>Or click to select files</p>
            <input type="file" id="fileInput" multiple accept=".pdf,.doc,.docx,.txt,.xlsx,.xls" style="display: none;">
            <div class="size-display">Maximum file size: 5MB</div>
            <div class="size-display">Allowed types: PDF, DOC, DOCX, TXT, XLSX, XLS</div>
        </div>

        <div class="test-files">
            <h3>Quick Test Files:</h3>
            <button class="test-file-btn" onclick="createTestFile('small', 'txt', 1024)">Small Text (1KB)</button>
            <button class="test-file-btn" onclick="createTestFile('medium', 'txt', 1024*1024)">Medium Text (1MB)</button>
            <button class="test-file-btn" onclick="createTestFile('large', 'txt', 4*1024*1024)">Large Text (4MB)</button>
            <button class="test-file-btn" onclick="createTestFile('oversized', 'txt', 6*1024*1024)">Oversized Text (6MB)</button>
            <button class="test-file-btn" onclick="createTestFile('invalid', 'exe', 1024)">Invalid Type (.exe)</button>
        </div>

        <div class="file-input">
            <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                üìÇ Select Files
            </button>
            <button class="btn btn-success" onclick="uploadSelectedFiles()">
                ‚¨ÜÔ∏è Upload Files
            </button>
            <button class="btn btn-warning" onclick="clearResults()">
                üóëÔ∏è Clear Results
            </button>
        </div>

        <div id="uploadProgress" style="display: none;">
            <h3>Upload Progress</h3>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>
            <div id="progressText">0%</div>
        </div>

        <div id="uploadResults"></div>
    </div>

    <div class="test-section">
        <h2>üì• File Download Testing</h2>
        <div id="downloadSection">
            <p>Available files for download testing:</p>
            <div id="fileList" class="file-list">Loading files...</div>
        </div>
    </div>

    <div class="test-section">
        <h2>üß™ Security Tests</h2>
        <div>
            <button class="btn btn-danger" onclick="testMaliciousUpload()">
                ‚ö†Ô∏è Test Malicious File Upload
            </button>
            <button class="btn btn-warning" onclick="testDirectAccess()">
                üîí Test Direct File Access
            </button>
            <button class="btn btn-info" onclick="testSizeValidation()">
                üìè Test Size Validation
            </button>
        </div>
        <div id="securityResults"></div>
    </div>

    <script>
        let selectedFiles = [];
        let contractId = 99; // Test contract ID

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadSystemStatus();
            loadFileList();
            setupDragAndDrop();
        });

        function loadSystemStatus() {
            fetch('../index.php?action=get_contract_types')
                .then(response => response.json())
                .then(data => {
                    const status = data.success ? 
                        '<div class="success">‚úÖ Backend API is operational</div>' :
                        '<div class="error">‚ùå Backend API error</div>';
                    document.getElementById('systemStatus').innerHTML = status;
                })
                .catch(error => {
                    document.getElementById('systemStatus').innerHTML = 
                        '<div class="error">‚ùå Cannot connect to backend API</div>';
                });
        }

        function loadFileList() {
            fetch('../index.php?action=get_uploaded_files')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.files) {
                        displayFileList(data.files);
                    } else {
                        // Fallback: show known files
                        const knownFiles = [
                            {name: '19.20251006-090553.pdf', size: 'Unknown', contract_id: 19},
                            {name: '29.20251006-085545.pdf', size: 'Unknown', contract_id: 29},
                            {name: '31.20250929-140848.docx', size: 'Unknown', contract_id: 31},
                            {name: '32.20251006-085459.pdf', size: 'Unknown', contract_id: 32}
                        ];
                        displayFileList(knownFiles);
                    }
                })
                .catch(error => {
                    document.getElementById('fileList').innerHTML = 
                        '<div class="error">Error loading file list: ' + error.message + '</div>';
                });
        }

        function displayFileList(files) {
            const fileListHTML = files.map(file => `
                <div class="file-item">
                    <h4>üìÑ ${file.name}</h4>
                    <p><strong>Size:</strong> ${file.size || 'Unknown'}</p>
                    <p><strong>Contract ID:</strong> ${file.contract_id || 'Unknown'}</p>
                    <button class="btn btn-primary" onclick="downloadFile('${file.name}')">
                        ‚¨áÔ∏è Download
                    </button>
                    <button class="btn btn-info" onclick="testFileAccess('${file.name}')">
                        üîç Test Access
                    </button>
                </div>
            `).join('');
            
            document.getElementById('fileList').innerHTML = fileListHTML;
        }

        function setupDragAndDrop() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');

            uploadArea.addEventListener('click', () => fileInput.click());

            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = Array.from(e.dataTransfer.files);
                handleFileSelection(files);
            });

            fileInput.addEventListener('change', (e) => {
                const files = Array.from(e.target.files);
                handleFileSelection(files);
            });
        }

        function handleFileSelection(files) {
            selectedFiles = files;
            displaySelectedFiles();
        }

        function displaySelectedFiles() {
            const resultsDiv = document.getElementById('uploadResults');
            if (selectedFiles.length === 0) {
                resultsDiv.innerHTML = '<div class="info">No files selected</div>';
                return;
            }

            const filesHTML = selectedFiles.map((file, index) => {
                const sizeClass = file.size > 5*1024*1024 ? 'error' : 'success';
                const typeClass = isValidFileType(file.name) ? 'success' : 'error';
                
                return `
                    <div class="file-item">
                        <h4>üìÑ ${file.name}</h4>
                        <p class="${sizeClass}"><strong>Size:</strong> ${formatBytes(file.size)} 
                           ${file.size > 5*1024*1024 ? '‚ùå Too large' : '‚úÖ Valid size'}</p>
                        <p class="${typeClass}"><strong>Type:</strong> ${file.type || 'Unknown'} 
                           ${isValidFileType(file.name) ? '‚úÖ Valid type' : '‚ùå Invalid type'}</p>
                    </div>
                `;
            }).join('');

            resultsDiv.innerHTML = `
                <h3>Selected Files (${selectedFiles.length})</h3>
                <div class="file-list">${filesHTML}</div>
            `;
        }

        function createTestFile(name, extension, size) {
            const content = 'A'.repeat(size);
            const blob = new Blob([content], {type: 'text/plain'});
            const file = new File([blob], `test_${name}_file.${extension}`, {type: 'text/plain'});
            
            selectedFiles = [file];
            displaySelectedFiles();
            
            addResult('info', `Created test file: ${file.name} (${formatBytes(file.size)})`);
        }

        function uploadSelectedFiles() {
            if (selectedFiles.length === 0) {
                addResult('error', 'No files selected for upload');
                return;
            }

            const formData = new FormData();
            formData.append('action', 'upload_contract_file');
            formData.append('contract_id', contractId);
            
            selectedFiles.forEach((file, index) => {
                formData.append('files[]', file);
            });

            showProgress(true);
            
            fetch('../index.php', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                showProgress(false);
                if (data.success) {
                    addResult('success', `‚úÖ Upload successful: ${data.message || 'Files uploaded'}`);
                    loadFileList(); // Refresh file list
                } else {
                    addResult('error', `‚ùå Upload failed: ${data.error || 'Unknown error'}`);
                }
            })
            .catch(error => {
                showProgress(false);
                addResult('error', `‚ùå Upload error: ${error.message}`);
            });
        }

        function downloadFile(filename) {
            addResult('info', `Attempting to download: ${filename}`);
            
            const downloadUrl = `../uploads/${filename}`;
            
            fetch(downloadUrl)
                .then(response => {
                    if (response.ok) {
                        return response.blob();
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                })
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    addResult('success', `‚úÖ Download started: ${filename}`);
                })
                .catch(error => {
                    addResult('error', `‚ùå Download failed: ${error.message}`);
                });
        }

        function testFileAccess(filename) {
            fetch(`../uploads/${filename}`, {method: 'HEAD'})
                .then(response => {
                    if (response.ok) {
                        addResult('success', `‚úÖ File accessible: ${filename} (${response.headers.get('content-length')} bytes)`);
                    } else {
                        addResult('error', `‚ùå File not accessible: ${filename} (${response.status})`);
                    }
                })
                .catch(error => {
                    addResult('error', `‚ùå Access test failed: ${error.message}`);
                });
        }

        function testMaliciousUpload() {
            const maliciousContent = '<?php echo "MALICIOUS CODE"; ?>';
            const blob = new Blob([maliciousContent], {type: 'text/plain'});
            const file = new File([blob], 'malicious.php', {type: 'text/plain'});
            
            selectedFiles = [file];
            displaySelectedFiles();
            addResult('warning', '‚ö†Ô∏è Created malicious PHP file for security testing');
        }

        function testDirectAccess() {
            const testUrls = [
                '../uploads/.htaccess',
                '../uploads/test.php',
                '../config/db.php',
                '../.env'
            ];
            
            addResult('info', 'üîí Testing direct access to protected files...');
            
            testUrls.forEach(url => {
                fetch(url)
                    .then(response => {
                        if (response.status === 403) {
                            addResult('success', `‚úÖ Protected: ${url} (403 Forbidden)`);
                        } else if (response.status === 404) {
                            addResult('info', `‚ÑπÔ∏è Not found: ${url} (404)`);
                        } else {
                            addResult('error', `‚ùå Accessible: ${url} (${response.status})`);
                        }
                    })
                    .catch(error => {
                        addResult('success', `‚úÖ Blocked: ${url} (Network error)`);
                    });
            });
        }

        function testSizeValidation() {
            addResult('info', 'üìè Testing file size validation...');
            
            // Test exactly 5MB file
            const exactSize = 5 * 1024 * 1024;
            const content = 'A'.repeat(exactSize);
            const blob = new Blob([content], {type: 'text/plain'});
            const file = new File([blob], 'exactly_5MB.txt', {type: 'text/plain'});
            
            selectedFiles = [file];
            displaySelectedFiles();
            addResult('info', `Created exactly 5MB file for size validation testing`);
        }

        function showProgress(show) {
            const progressDiv = document.getElementById('uploadProgress');
            if (show) {
                progressDiv.style.display = 'block';
                let progress = 0;
                const interval = setInterval(() => {
                    progress += 10;
                    document.getElementById('progressFill').style.width = progress + '%';
                    document.getElementById('progressText').textContent = progress + '%';
                    if (progress >= 100) {
                        clearInterval(interval);
                    }
                }, 100);
            } else {
                progressDiv.style.display = 'none';
                document.getElementById('progressFill').style.width = '0%';
                document.getElementById('progressText').textContent = '0%';
            }
        }

        function addResult(type, message) {
            const resultsDiv = document.getElementById('uploadResults');
            const resultHTML = `<div class="${type}">${message}</div>`;
            resultsDiv.innerHTML += resultHTML;
        }

        function clearResults() {
            document.getElementById('uploadResults').innerHTML = '';
            document.getElementById('securityResults').innerHTML = '';
            selectedFiles = [];
        }

        function isValidFileType(filename) {
            const validExtensions = ['.pdf', '.doc', '.docx', '.txt', '.xlsx', '.xls'];
            return validExtensions.some(ext => filename.toLowerCase().endsWith(ext));
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
    </script>
</body>
</html>